---
title: "mini project: the Raspberry Pi Zero USB gadget"
date: 2020-02-14
slug: work-zero-gadget
tags: []
description: 
canonical_url: 
layout: post
---
<p>Of all of my projects, this one is probably going to be one of the easier ones.  This project is a little more open ended, but all you really need is the following:</p><ul><li>Raspberry Pi Zero W (<a href="https://www.adafruit.com/product/3400">Adafruit</a>)</li><li>Raspberry Pi Zero Case (<a href="https://www.adafruit.com/product/3446">this one</a> or <a href="https://www.adafruit.com/product/3252">this one</a>, for example)</li><li>Micro USB Data Cable (<em>not a charge-only cable</em>) (<a href="https://amzn.to/2SnBLhD">Amazon</a>)</li></ul><p>The challenge for many of us that we’re not always at our test bench, and making Pi equipment portable gets bulky really fast. If you’re using a regular Raspberry Pi, you need a Pi, an enclosure, a power adapter, and a wireless network to join- just as an example.</p><p>Where this gets complicated is if you’re in a spot where wireless is expensive (like an airport) or tightly regulated (like your work or school).  An easy workaround is to turn on tethering on your mobile phone, but running your PC’s internet through tethering gets expensive, and fast.</p><p>The fix is actually pretty simple, and uses some common approaches well documented already- but in a typical weekend project, we’ll pull a few articles together to get you this project.</p><p>As you can see there’s only a few things to do- enable networking over the USB port, and configure the wireless interface.  There are already how-to’s for different PC/Mac platforms, but this guide covers all of them in a single approach.</p><p>First, what we need to do is enable the USB Gadget support on the Raspberry Pi Zero W.  This will let the Raspberry Pi turn the USB data port into an Ethernet USB adapter.  It’s pretty easy.  Run the following command:</p><pre><code>sudo nano /boot/config.txt</code></pre><p>And add the following lines to the end- the # sign allows us to place a comment so we can leave a note for ourselves later.</p><pre><code>#added for USB gadget support</code></pre><pre><code>dtoverlay=dwc2</code></pre><p>Next, we need to modify another boot file, go ahead and run</p><pre><code>sudo nano  /boot/cmdline.txt</code></pre><p>and add this specifically to the end of the line:</p><pre><code>modules-load=dwc2,g_ether</code></pre><p>It will look something like this:</p><p>If you haven’t already, go ahead and make sure you’re on the wireless network at home by running</p><pre><code>sudo raspi-config</code></pre><p>Go into <em>Network Options -&gt; Wi-Fi</em> and enter your wireless network info.  Next, go into <em>Interfacing Options -&gt; SSH -&gt; Enable SSH</em> when asked.</p><p>With an HDMI cable plugged in, go ahead and exit out of raspi-config and reboot.</p><p>When you reboot, look at the boot messages just before you get to the login prompt, you should have a wireless network IP.  Let’s say it’s 10.1.1.22. Go ahead and login via SSH by running from your PC or Mac console:</p><pre><code>ssh -l pi 10.1.1.22</code></pre><p>Answer yes when prompted and go ahead and login.  The next thing we’ll do is make some major changes to the networking system on your Pi, so if you have stuff you need to back up, or you’re not starting from a fresh Pi install, go back and resolve those things now.</p><p>OK, so before jumping in, here’s what we’re going to do- we’re going to remove the dhcpcd program, which handles address assignment for the Raspbian install on the Pi we have now.  There are reasons why you want to leave that in place for other Pi systems, but in order to do what we want, we need it gone.  We’re also going to install the DHCP server software dnsmasq, which will let us run our own little DHCP server on the USB port.  This will let us connect the Pi to a Linux, Mac, or Windows PC without needing any additional software.  Finally, we’ll also add network entries for the WiFi adapter and the USB Ethernet allowing us to do something pretty cool- connect to our PC over USB while also connecting to our phone’s tethered hotspot for the Pi Zero W.</p><p>Install dnsmasq:</p><pre><code>sudo apt-get install -y dnsmasq</code></pre><p>Configure dnsmasq:</p><pre><code>sudo nano /etc/dnsmasq.conf</code></pre><p>Add the following lines at the bottom:</p><pre><code>dhcp-range=10.77.77.78,10.77.77.99,12h</code></pre><pre><code>dhcp-option=3</code></pre><pre><code>dhcp-option=6</code></pre><p>The DHCP range will need to match the interface IP address we assign to the usb0 interface in the next step.  DHCP options 3 and 6 are annotated in the config file, but they prevent dnsmaq from advertising a default route or dns- we don’t need this Pi to be a DNS server or a router for this tutorial.</p><p>Go ahead and save and exit from the file, we won’t start dnsmasq just yet though.</p><p>Next, we’re going to disable dhcpcd, the current system that assigns IP addresses.  Disable it with:</p><pre><code>sudo systemctl disable dhcpcd</code></pre><p>Now let’s add our manual network interface setup:</p><pre><code>sudo nano /etc/network/interfaces</code></pre><p>In there you will probably see something that says:</p><pre><code>source-directory /etc/network/interfaces.d</code></pre><p>Go ahead and leave that in.  Below it, add all of this text, paying attention to the indents:</p><pre><code>auto lo
iface lo inet loopback

auto usb0
allow-hotplug usb0
iface usb0 inet static
address 10.77.77.77
netmask 255.255.255.0

allow-hotplug wlan0
iface wlan0 inet dhcp
    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
</code></pre><p>Go ahead and save and exit- remember the address set for usb0 needs to line up with the dnsmasq.conf settings from above.</p><p>Finally, let’s make sure your phone’s hotspot connection is in /etc/wpa_supplicant/wpa_supplicant.conf.</p><p>Run:</p><pre><code>sudo nano /etc/wpa_supplicant/wpa_supplicant.conf</code></pre><p>In there, each network should be listed like this:</p><pre><code>network={
        ssid="Your-Phone-Hotspot-SSID"
        psk="yourpassphrase"
}</code></pre><p>With that done, go ahead and run this command to reboot:</p><p>sudo halt</p><p>Give the Pi 30 seconds or so to shut down, then unplug it.  You should not need any power cord, just the USB data cable plugged into your desktop or laptop on one end, and the micro USB port on the Pi Zero W that’s closest to the middle of the Pi.  When it boots it will look like a network adapter, and it should assign an IP address in the 10.77.77.x range to your computer.  You should be able to open a command prompt on your PC or Mac and type:</p><pre><code>ssh -l pi 10.77.77.77</code></pre><p>And login.  If you haven’t changed your password- do it now with this command:</p><pre><code>passwd</code></pre><p>After that, you should be able to run</p><pre><code> ifconfig -a </code></pre><p>and see an IP address on your wireless network adapter.  The Pi Zero W is slower than many modern Pis, so it may take a couple minutes after boot to get an IP address.</p><p>Now that you’re setup, you can plug your Pi directly into your PC and get to it without any 3rd party software and the Pi can use a separate wireless network such as your phone.  This helps create a setup that’s friendly for travel and requires very little cost. I hope you find this helpful.</p><h3 id="reference">Reference:</h3><ul><li>Thanks to Kevin Shumaker (@Starbasessd on Twitter) for his nudge in the right direction, specifically that dhcpcd and /etc/network/interfaces were conflicting.</li><li><a href="https://learn.adafruit.com/turning-your-raspberry-pi-zero-into-a-usb-gadget/ethernet-gadget">Adafruit’s USB Gadget Learning Guide</a></li><li><a href="http://shallowsky.com/blog/linux/raspberry-pi-ethernet-gadget.html">Setting static IP addresses for usb0</a></li><li><a href="http://www.circuitbasics.com/raspberry-pi-zero-ethernet-gadget/">Circuit Basics’ Raspberry Pi USB Gadget Guide</a></li></ul>
